(()=>{"use strict";class N{constructor(t,e,s){this.type="sphere",this.center=t,this.radius=e,this.material=s}hit(t,e,s){const a=t.origin.subtract(this.center),i=t.direction.dot(t.direction),o=a.dot(t.direction),l=o*o-i*(a.dot(a)-this.radius*this.radius);if(l<0)return!1;const p=Math.sqrt(l);let h=(-o-p)/i;if(!e.surrounds(h)&&(h=(-o+p)/i,!e.surrounds(h)))return!1;s.t=h,s.p=t.at(s.t);const d=s.p.subtract(this.center).divide(this.radius);return s.setFaceNormal(t,d),s.material=this.material,!0}}const y=(r,t)=>Math.random()*(t-r)+r;class n{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}add(t){return new n(this.x+t.x,this.y+t.y,this.z+t.z)}subtract(t){return new n(this.x-t.x,this.y-t.y,this.z-t.z)}vectorMultiply(t){return new n(this.x*t.x,this.y*t.y,this.z*t.z)}multiply(t){return new n(this.x*t,this.y*t,this.z*t)}divide(t){return new n(this.x/t,this.y/t,this.z/t)}negate(){return new n(-this.x,-this.y,-this.z)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new n(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}unitVector(){return this.divide(this.length())}nearZero(){return Math.abs(this.x)<1e-8&&Math.abs(this.y)<1e-8&&Math.abs(this.z)<1e-8}clone(){return new n(this.x,this.y,this.z)}static randomUnitVector(){return n.randomInUnitSphere().unitVector()}static randomInUnitSphere(){for(;;){const t=n.random(-1,1);if(t.lengthSquared()<1)return t}}static randomOnHemisphere(t){const e=n.randomUnitVector();return e.dot(t)>0?e:e.negate()}static randomInUnitDisk(){for(;;){const t=new n(y(-1,1),y(-1,1),0);if(t.lengthSquared()<1)return t}}static random(t=0,e=1){return new n(y(t,e),y(t,e),y(t,e))}static reflect(t,e){return t.subtract(e.multiply(2*t.dot(e)))}static refract(t,e,s){const a=Math.min(t.negate().dot(e),1),i=t.add(e.multiply(a)).multiply(s),o=e.multiply(-Math.sqrt(Math.abs(1-i.lengthSquared())));return i.add(o)}}class O{constructor(){this.p=new n,this.normal=new n,this.t=0,this.frontFace=!1}setFaceNormal(t,e){this.frontFace=t.direction.dot(e)<0,this.normal=this.frontFace?e:e.negate()}}var m;class x{constructor(t,e){this.min=t??Number.NEGATIVE_INFINITY,this.max=e??Number.POSITIVE_INFINITY}contains(t){return this.min<=t&&t<=this.max}surrounds(t){return this.min<t&&t<this.max}clamp(t){return t<this.min?this.min:t>this.max?this.max:t}}(m=x).EMPTY=new m(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY),m.UNIVERSE=new m;class k{constructor(){this.type="hittableList",this.objects=[]}add(t){this.objects.push(t)}hit(t,e,s){const a=new O;let i=!1,o=e.max;for(let c=0;c<this.objects.length;c+=1)this.objects[c].hit(t,new x(e.min,o),a)&&(i=!0,o=a.t,Object.assign(s,a));return i}}class f{constructor(t=new n,e=new n){this.origin=t,this.direction=e}at(t){return this.direction.multiply(t).add(this.origin)}}class D{constructor(t){this.type="dielectric",this.ir=t}scatter(t,e,s,a){Object.assign(s,new n(1,1,1));const i=e.frontFace?1/this.ir:this.ir,o=t.direction.unitVector(),c=Math.min(o.negate().dot(e.normal),1);let h;h=i*Math.sqrt(1-c*c)>1||this.reflectance(c,i)>Math.random()?n.reflect(o,e.normal):n.refract(o,e.normal,i);const d=n.refract(o,e.normal,i);return Object.assign(a,new f(e.p,d)),!0}reflectance(t,e){let s=(1-e)/(1+e);return s*=s,s+(1-s)*(1-t)**5}}class U{constructor(t){this.type="lambertian",this.albedo=t}scatter(t,e,s,a){let i=e.normal.add(n.randomUnitVector());return i.nearZero()&&(i=e.normal),Object.assign(a,new f(e.p,i)),Object.assign(s,this.albedo),!0}}class T{constructor(t,e=1){this.type="metal",this.albedo=t,this.fuzz=e<1?e:1}scatter(t,e,s,a){const i=n.reflect(t.direction.unitVector(),e.normal);return Object.assign(a,new f(e.p,i.add(n.randomInUnitSphere().multiply(this.fuzz)))),Object.assign(s,this.albedo),!0}}const P=(r,t,e,s)=>{const a=new O;if(e<=0)return new n(0,0,0);if(t.hit(r,new x(.001,Number.POSITIVE_INFINITY),a)){const c=new f,l=new n;return a.material.scatter(r,a,l,c)?l.vectorMultiply(P(c,t,e-1,s)):new n(0,0,0)}const o=.5*(r.direction.unitVector().y+1);return new n(1,1,1).multiply(1-o).add(s.multiply(o))},F=(r,t,e,s,a,i,o,c,l)=>{const h=s.add(a.multiply(r)).add(i.multiply(t)).add(((r,t)=>{const e=-.5+Math.random(),s=-.5+Math.random();return r.multiply(e).add(t.multiply(s))})(a,i)),d=e<=0?o:((r,t,e)=>{const s=n.randomInUnitDisk();return r.add(t.multiply(s.x)).add(e.multiply(s.y))})(o,c,l),b=h.subtract(d);return new f(o,b)},w=r=>Math.sqrt(r),L=(r,t,e,s)=>{const a=1/t;let i=r.x*a,o=r.y*a,c=r.z*a;i=w(i),o=w(o),c=w(c),s.push(255*e.clamp(i)),s.push(255*e.clamp(o)),s.push(255*e.clamp(c)),s.push(255)},u=r=>{Object.setPrototypeOf(r,n.prototype)},z=r=>{switch(r.type){case"hittableList":(r=>{Object.setPrototypeOf(r,k.prototype),r.objects.forEach(t=>{z(t)})})(r);break;case"sphere":(r=>{Object.setPrototypeOf(r,N.prototype),u(r.center),A(r.material)})(r);break;default:console.error(`Unsupported type: ${r.type}`)}},A=r=>{switch(r.type){case"dielectric":Object.setPrototypeOf(r,D.prototype);break;case"lambertian":Object.setPrototypeOf(r,U.prototype);break;case"metal":Object.setPrototypeOf(r,T.prototype);break;default:console.error(`Unsupported type: ${r.type}`)}};addEventListener("message",({data:r})=>{(r=>{u(r.pixel00Location),u(r.pixelDeltaU),u(r.pixelDeltaV),u(r.center),u(r.defocusDiskU),u(r.defocusDiskV),u(r.skyBoxColor),(r=>{Object.setPrototypeOf(r,x.prototype)})(r.intensity),z(r.world)})(r),postMessage((r=>{const{rowIndex:t,imageWidth:e,samplesPerPixel:s,pixel00Location:a,pixelDeltaU:i,pixelDeltaV:o,defocusAngle:c,world:l,center:p,maxDepth:h,defocusDiskU:d,defocusDiskV:b,skyBoxColor:B,intensity:Z}=r,M=[];for(let g=0;g<e;g+=1){let I=new n(0,0,0);for(let S=0;S<s;S+=1){const $=F(g,t,c,a,i,o,p,d,b);I=I.add(P($,l,h,B))}L(I,s,Z,M)}return{rowImgData:M,rowIndex:t}})(r))})})();