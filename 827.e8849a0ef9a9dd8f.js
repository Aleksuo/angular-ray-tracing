(()=>{"use strict";class Tt{constructor(t,e,s){this.type="sphere",this.center=t,this.radius=e,this.material=s}hit(t,e,s){const o=t.origin.subtract(this.center),r=t.direction.dot(t.direction),i=o.dot(t.direction),y=i*i-r*(o.dot(o)-this.radius*this.radius);if(y<0)return!1;const w=Math.sqrt(y);let m=(-i-w)/r;if(!e.surrounds(m)&&(m=(-i+w)/r,!e.surrounds(m)))return!1;s.t=m,s.p=t.at(s.t);const f=s.p.subtract(this.center).divide(this.radius);return s.setFaceNormal(t,f),s.material=this.material,!0}}const tt=(n,t)=>Math.random()*(t-n)+n;class c{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}add(t){return new c(this.x+t.x,this.y+t.y,this.z+t.z)}subtract(t){return new c(this.x-t.x,this.y-t.y,this.z-t.z)}vectorMultiply(t){return new c(this.x*t.x,this.y*t.y,this.z*t.z)}multiply(t){return new c(this.x*t,this.y*t,this.z*t)}divide(t){return new c(this.x/t,this.y/t,this.z/t)}negate(){return new c(-this.x,-this.y,-this.z)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new c(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}unitVector(){return this.divide(this.length())}nearZero(){return Math.abs(this.x)<1e-8&&Math.abs(this.y)<1e-8&&Math.abs(this.z)<1e-8}clone(){return new c(this.x,this.y,this.z)}static randomUnitVector(){return c.randomInUnitSphere().unitVector()}static randomInUnitSphere(){for(;;){const t=c.random(-1,1);if(t.lengthSquared()<1)return t}}static randomOnHemisphere(t){const e=c.randomUnitVector();return e.dot(t)>0?e:e.negate()}static randomInUnitDisk(){for(;;){const t=new c(tt(-1,1),tt(-1,1),0);if(t.lengthSquared()<1)return t}}static random(t=0,e=1){return new c(tt(t,e),tt(t,e),tt(t,e))}static reflect(t,e){return t.subtract(e.multiply(2*t.dot(e)))}static refract(t,e,s){const o=Math.min(t.negate().dot(e),1),r=t.add(e.multiply(o)).multiply(s),i=e.multiply(-Math.sqrt(Math.abs(1-r.lengthSquared())));return r.add(i)}}class qt{constructor(){this.p=new c,this.normal=new c,this.t=0,this.frontFace=!1}setFaceNormal(t,e){this.frontFace=t.direction.dot(e)<0,this.normal=this.frontFace?e:e.negate()}}var et;class pt{constructor(t,e){this.min=t??Number.NEGATIVE_INFINITY,this.max=e??Number.POSITIVE_INFINITY}contains(t){return this.min<=t&&t<=this.max}surrounds(t){return this.min<t&&t<this.max}clamp(t){return t<this.min?this.min:t>this.max?this.max:t}}(et=pt).EMPTY=new et(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY),et.UNIVERSE=new et;class Et{constructor(){this.type="hittableList",this.objects=[]}add(t){this.objects.push(t)}hit(t,e,s){const o=new qt;let r=!1,i=e.max;for(let a=0;a<this.objects.length;a+=1)this.objects[a].hit(t,new pt(e.min,i),o)&&(r=!0,i=o.t,Object.assign(s,o));return r}}class ${constructor(t=new c,e=new c){this.origin=t,this.direction=e}at(t){return this.direction.multiply(t).add(this.origin)}}class Yt{constructor(t){this.type="dielectric",this.ir=t}scatter(t,e,s,o){Object.assign(s,new c(1,1,1));const r=e.frontFace?1/this.ir:this.ir,i=t.direction.unitVector(),a=Math.min(i.negate().dot(e.normal),1);let m;m=r*Math.sqrt(1-a*a)>1||this.reflectance(a,r)>Math.random()?c.reflect(i,e.normal):c.refract(i,e.normal,r);const f=c.refract(i,e.normal,r);return Object.assign(o,new $(e.p,f)),!0}reflectance(t,e){let s=(1-e)/(1+e);return s*=s,s+(1-s)*(1-t)**5}}class Lt{constructor(t){this.type="lambertian",this.albedo=t}scatter(t,e,s,o){let r=e.normal.add(c.randomUnitVector());return r.nearZero()&&(r=e.normal),Object.assign(o,new $(e.p,r)),Object.assign(s,this.albedo),!0}}Math.sqrt(3),Math.sqrt(3);const G=1/6,Y=(Math.sqrt(5),Math.sqrt(5),n=>0|Math.floor(n)),yt=new Float64Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);class Ct{constructor(t,e,s){this.type="marble",this.albedo_stripe=t,this.albedo_base=e,this.noiseSeed=s}scatter(t,e,s,o){this.instantiateNoiseFnIfNotDefined();let r=e.normal.add(c.randomUnitVector());return r.nearZero()&&(r=e.normal),Object.assign(o,new $(e.p,r)),Object.assign(s,this.sampleMarble(e.p)),!0}turbulence(t,e){let s=0,o=1,r=new c(t.x,t.y,t.z);for(;o>e;)r=r.divide(o),s+=this.noiseFn(r.x,r.y,r.z)*o,o/=2;return s}sampleMarble(t){const e=new c(0,0,0);let s=Math.sin((t.y+3*this.turbulence(t,.00125))*Math.PI);return s=.7071*Math.sqrt(s+1),e.y=this.albedo_stripe.y+this.albedo_base.y*s,s=Math.sqrt(s),e.x=this.albedo_stripe.x+this.albedo_base.x*s,e.z=this.albedo_stripe.z+this.albedo_base.z*s,e}instantiateNoiseFnIfNotDefined(){this.noiseFn||(this.noiseFn=function Zt(n=Math.random){const t=function mt(n){const e=new Uint8Array(512);for(let s=0;s<256;s++)e[s]=s;for(let s=0;s<255;s++){const o=s+~~(n()*(256-s)),r=e[s];e[s]=e[o],e[o]=r}for(let s=256;s<512;s++)e[s]=e[s-256];return e}(n),e=new Float64Array(t).map(r=>yt[r%12*3]),s=new Float64Array(t).map(r=>yt[r%12*3+1]),o=new Float64Array(t).map(r=>yt[r%12*3+2]);return function(i,a,y){let w,m,f,O;const j=.3333333333333333*(i+a+y),U=Y(i+j),q=Y(a+j),b=Y(y+j),g=(U+q+b)*G,z=i-(U-g),P=a-(q-g),I=y-(b-g);let S,N,h,u,p,l;z>=P?P>=I?(S=1,N=0,h=0,u=1,p=1,l=0):z>=I?(S=1,N=0,h=0,u=1,p=0,l=1):(S=0,N=0,h=1,u=1,p=0,l=1):P<I?(S=0,N=0,h=1,u=0,p=1,l=1):z<I?(S=0,N=1,h=0,u=0,p=1,l=1):(S=0,N=1,h=0,u=1,p=1,l=0);const F=z-S+G,k=P-N+G,T=I-h+G,E=z-u+2*G,J=P-p+2*G,K=I-l+2*G,Q=z-1+.5,v=P-1+.5,R=I-1+.5,X=255&U,B=255&q,W=255&b;let H=.6-z*z-P*P-I*I;if(H<0)w=0;else{const x=X+t[B+t[W]];H*=H,w=H*H*(e[x]*z+s[x]*P+o[x]*I)}let _=.6-F*F-k*k-T*T;if(_<0)m=0;else{const x=X+S+t[B+N+t[W+h]];_*=_,m=_*_*(e[x]*F+s[x]*k+o[x]*T)}let Z=.6-E*E-J*J-K*K;if(Z<0)f=0;else{const x=X+u+t[B+p+t[W+l]];Z*=Z,f=Z*Z*(e[x]*E+s[x]*J+o[x]*K)}let C=.6-Q*Q-v*v-R*R;if(C<0)O=0;else{const x=X+1+t[B+1+t[W+1]];C*=C,O=C*C*(e[x]*Q+s[x]*v+o[x]*R)}return 32*(w+m+f+O)}}(()=>this.noiseSeed))}}class Xt{constructor(t,e=1){this.type="metal",this.albedo=t,this.fuzz=e<1?e:1}scatter(t,e,s,o){const r=c.reflect(t.direction.unitVector(),e.normal);return Object.assign(o,new $(e.p,r.add(c.randomInUnitSphere().multiply(this.fuzz)))),Object.assign(s,this.albedo),!0}}const Ut=(n,t,e,s)=>{const o=new qt;if(e<=0)return new c(0,0,0);if(t.hit(n,new pt(.001,Number.POSITIVE_INFINITY),o)){const a=new $,y=new c;return o.material.scatter(n,o,y,a)?y.vectorMultiply(Ut(a,t,e-1,s)):new c(0,0,0)}const i=.5*(n.direction.unitVector().y+1);return new c(1,1,1).multiply(1-i).add(s.multiply(i))},$t=(n,t,e,s,o,r,i,a,y)=>{const m=s.add(o.multiply(n)).add(r.multiply(t)).add(((n,t)=>{const e=-.5+Math.random(),s=-.5+Math.random();return n.multiply(e).add(t.multiply(s))})(o,r)),f=e<=0?i:((n,t,e)=>{const s=c.randomInUnitDisk();return n.add(t.multiply(s.x)).add(e.multiply(s.y))})(i,a,y),O=m.subtract(f);return new $(i,O)},ft=n=>Math.sqrt(n),Jt=(n,t,e,s)=>{const o=1/t;let r=n.x*o,i=n.y*o,a=n.z*o;r=ft(r),i=ft(i),a=ft(a),s.push(255*e.clamp(r)),s.push(255*e.clamp(i)),s.push(255*e.clamp(a)),s.push(255)},V=n=>{Object.setPrototypeOf(n,c.prototype)},Gt=n=>{switch(n.type){case"hittableList":(n=>{Object.setPrototypeOf(n,Et.prototype),n.objects.forEach(t=>{Gt(t)})})(n);break;case"sphere":(n=>{Object.setPrototypeOf(n,Tt.prototype),V(n.center),Rt(n.material)})(n);break;default:console.error(`Unsupported type: ${n.type}`)}},Rt=n=>{switch(n.type){case"dielectric":Object.setPrototypeOf(n,Yt.prototype);break;case"lambertian":Object.setPrototypeOf(n,Lt.prototype);break;case"metal":Object.setPrototypeOf(n,Xt.prototype);break;case"marble":Object.setPrototypeOf(n,Ct.prototype);break;default:console.error(`Unsupported type: ${n.type}`)}};addEventListener("message",({data:n})=>{(n=>{V(n.pixel00Location),V(n.pixelDeltaU),V(n.pixelDeltaV),V(n.center),V(n.defocusDiskU),V(n.defocusDiskV),V(n.skyBoxColor),(n=>{Object.setPrototypeOf(n,pt.prototype)})(n.intensity),Gt(n.world)})(n),postMessage((n=>{const{rowIndex:t,imageWidth:e,samplesPerPixel:s,pixel00Location:o,pixelDeltaU:r,pixelDeltaV:i,defocusAngle:a,world:y,center:w,maxDepth:m,defocusDiskU:f,defocusDiskV:O,skyBoxColor:j,intensity:U}=n,q=[];for(let b=0;b<e;b+=1){let g=new c(0,0,0);for(let D=0;D<s;D+=1){const A=$t(b,t,a,o,r,i,w,f,O);g=g.add(Ut(A,y,m,j))}Jt(g,s,U,q)}return{rowImgData:q,rowIndex:t}})(n))})})();